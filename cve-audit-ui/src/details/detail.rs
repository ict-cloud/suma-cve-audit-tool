use yew::prelude::*;
use cve_audit_types::*;
use log;

#[function_component(CveDetails)]
pub fn cvedetails() -> Html {
    html!{
        <div>
          <h2>{"CVE Detail Page"}</h2>
          <br/>
          <strong>{"Description"}</strong>
          <br/>
          {"Beschreibung des CVE mit einem l√§ngeren Text"}
          <br/>
          <strong>{"SUSE Errata"}</strong>
          <br/>
          {"Liste der SUSE Errate welche beinhaltet sind"}
          <br/>
        </div>
    }
}

#[function_component(ErrataDetails)]
pub fn erratadetails() -> Html {
    let url = "http://localhost:8081/api/errata/24143";
    let empty_errata: cve_audit_types::ErrataExtended = cve_audit_types::ErrataExtended{
      id: 0,
      date: String::from(""),
      update_date: String::from(""),
      advisory_synopsis: String::from(""),
      advisory_type: String::from(""),
      advisory_name: String::from(""),
      cves: Vec::new(),
      sys_affected: false,
    };
    let errata = use_state(|| empty_errata );
    { // needed because of lifetime issues otherwise
        let errata = errata.clone();
        use_effect_with_deps(move |url| {
            let errata = errata.clone();
            let url = url.clone();
            wasm_bindgen_futures::spawn_local(async move {
                let fetched_errata: cve_audit_types::ErrataExtended = reqwasm::http::Request::get(url)
                    .send()
                    .await
                    .unwrap()
                    .json()
                    .await
                    .unwrap();
                errata.set(fetched_errata);
            });
            || ()
        }, url.clone() ); // dependents here
    }

    log::info!("entries are {:?}", errata);

    html!{
        {render_details(errata)}
    }
}

fn render_details(entries: yew::UseStateHandle<cve_audit_types::ErrataExtended>) -> Html {
  let entry = &*entries.clone();
  //let entry = recs.iter().next().unwrap();

  html!{
    <div>
      <h2>{format!{"SUSE Errata {}", entry.id}}</h2>
      <br/>
      <strong>{&entry.advisory_name}</strong>
      <br/>
      {&entry.advisory_synopsis}
      <br/>
      <strong>{"Errata Type: "}</strong>{&entry.advisory_type}<br/>
      <strong>{"Update Date: "}</strong>{&entry.update_date}<br/>
      <br/>
      <br/>
      <strong>{"CVEs"}</strong>
      <br/>
      <ul>{ entry.cves.iter().map(|cve| render_cve_details(cve)).collect::<Html>() }</ul>
      <br/>
    </div>
  }
}

fn render_cve_details(cve: &str) -> Html {
  html!{
    <li>{cve}</li>
  }
}