use yew::prelude::*;
use cve_audit_types::*;

#[derive(Properties, PartialEq)]
pub struct AuditTrailProps {
    pub errata_id: u32,
}

#[function_component(AuditTrailList)]
pub fn audit_trail_list(audit_trail_props: &AuditTrailProps) -> Html {
    let empty_trail = cve_audit_types::ErrataAuditData{
        id: 0,
        errata_id: 0,
        audit_date: String::from("2022-01-01"),
        auditor: String::from(""),
        resp: String::from(""),
        status: AuditStatus::New,
        assessment_verdict: AuditAssessment::Unclear,
        assessed_score: 0.0,
        assessment_comment: String::from(""),
    };
    let audit_trail = use_state(|| empty_trail);
    let url = format!("http://localhost:8081/api/errata/{}/audittrail", audit_trail_props.errata_id);
    {
        let audit_trail = audit_trail.clone();
        use_effect_with_deps(move |url| {
            let audit_trail = audit_trail.clone();
            let url = url.clone();
            wasm_bindgen_futures::spawn_local(async move {
                let fetched_at: cve_audit_types::ErrataAuditData = reqwasm::http::Request::get(url.as_str())
                    .send()
                    .await
                    .unwrap()
                    .json()
                    .await
                    .unwrap();
                audit_trail.set(fetched_at);
            });
            || ()
        }, url.clone());
    }

    html! {
        <div>
            {"List"}
            {render_list(audit_trail)}
        </div>
    }
}

fn render_list(audit_trail: yew::UseStateHandle<cve_audit_types::ErrataAuditData>) -> Html {
    let aud_trail = &*audit_trail.clone();
    if aud_trail.id != 0 {
        html! {
            <div class={classes!("list", "table-responsive")}>
              <table class={classes!("table", "table-striped", "table-sm")}>
                <thead>
                  <tr>
                    <th scope={"col"}>{"Date"}</th>
                    <th scope={"col"}>{"Status"}</th>
                    <th scope={"col"}>{"Assessment"}</th>
                    <th scope={"col"}>{"Assessed Score"}</th> 
                    <th scope={"col"}>{"Auditor"}</th>
                    <th scope={"col"}>{"Responsible"}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{&aud_trail.audit_date}</td>
                    <td>{&aud_trail.status}</td>
                    <td>{&aud_trail.assessment_verdict}</td>
                    <td>{&aud_trail.assessed_score}</td>
                    <td>{&aud_trail.auditor}</td>
                    <td>{&aud_trail.resp}</td>
                  </tr>
                </tbody>
              </table>
            </div>
        }
    } else {
        html! {
            <div class={classes!("loading")}>{"loading..."}</div>
        }
    }
}